<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>富文本编辑器</title>
    <link rel="stylesheet" th:href="@{/layui/css/layui.css}"/>
    <link rel="stylesheet" th:href="@{/admin/css/pearForm.css}"/>
    <style>
        body {
            margin: 10px;
            background-color: whitesmoke;
            font-family: 'Roboto', sans-serif;
            font-size: 15px;
        }
    </style>

    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
</head>
<body>
<div class="layui-fluid">

    <form class="layui-form layui-form-pane" action="" id="request_form">

        <fieldset class="layui-elem-field site-demo-button" style="margin-top: 30px;">
            <div class="layui-form-item">
                <div class="layui-input-inline">
                    <select name="method" lay-verify="method">
                        <option value="NON" disabled>请选择请求方式</option>
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                        <option value="PATCH">PATCH</option>
                        <option value="OPTION">OPTION</option>
                    </select>
                </div>
                <label class="layui-form-label">http://</label>
                <div class="layui-input-inline">
                    <input type="text" name="url" placeholder="url" lay-verify="url" autocomplete="off"
                           style="width: 220%"
                           class="layui-input">

                </div>
                <button class="layui-btn" style="margin-left: 25%;float: left" lay-submit lay-filter="*">执行</button>
            </div>
        </fieldset>

        <div th:include="docs/add_snippet/urivar :: urivar"></div>

        <div th:include="docs/add_snippet/header :: header"></div>

        <div th:include="docs/add_snippet/content :: content"></div>

        <div th:include="docs/add_snippet/response :: response"></div>

    </form>
</div>

<script th:src="@{/layui/layui.js}"></script>
<script th:src="@{/admin/js/jquery.js}"></script>
<script type="text/javascript" th:inline="javascript">

    var msg;

    layui.use([
        'util', 'layer',
        'form', 'upload',
        'element', 'jquery'], function () {

        var form = layui.form;
        var $ = layui.jquery;
        msg = layui.layer;
        var layer = layui.layer;

        form.verify({
            url: function (value, item) {
                if (!new RegExp("^(http(s?)\\:\\/\\/)?[0-9a-zA-Z]([-.\\w]*[0-9a-zA-Z])*(:(0-9)*)*(\\/?)([a-zA-Z0-9\\-\\.\\?\\,\\'\\/\\\\\\+&amp;%$#_]*)?$").test(value)) {
                    return "URL格式不正确";
                }
            },
            type: function (value, item) {
                if (value === "NON")
                    return "请选择参数类型";
            }
            , pass: []
        });


        $('#convert_json_to_fields').click(function (event) {
            layer.open({
                title: 'JSON快速转换',
                area: ['900px', '600px'],
                scrollbar: false,
                type: 2,
                content: '/restdoc/docs/json/convert',
                closeBtn: 1,
                btn: ['转换JSON', "格式化JSON"],
                yes: function (index, layero) {
                    var res = window["layui-layer-iframe" + index].getJSONValue();
                    $.ajax({
                        type: 'POST',
                        dataType: 'JSON',
                        contentType: 'application/json;charset=utf-8',
                        url: 'docs/deProjector',
                        data: res,
                        async: false,
                        success: function (data) {
                            if (data.code === '200') {
                                if (data.data.length >= 1) {
                                    let firstLine = data.data[0];
                                    $("#first-request-body-field input").each(function () {
                                        if (this.name === 'requestFieldPath') {
                                            this.value = firstLine['path']
                                        } else if (this.name === 'requestFieldValue') {
                                            this.value = firstLine['value']
                                        }
                                    });
                                    console.info($(".multi-request-body").length)

                                    let multiDivEls = $(".multi-request-body");

                                    multiDivEls.each(function (item) {
                                        console.info(item)
                                    })

                                }
                            } else {
                                layer.msg('JSON转换失败，错误信息:' + data.message)
                            }
                        },
                        error: function (data) {
                            layer.msg("JSON格式错误")
                        }
                    });
                    layer.close(index); //如果设定了yes回调，需进行手工关闭
                }
            });
        });

        $("#add_request_header_field").click(function (event) {

            let row = $('#first-header-field').html();
            var html = '  <div class="layui-form-item">' + row + '</div>';
            $("#request-header-div").after(html);

            form.render();
        });

        $("#add_request_body_field").click(function (event) {

            let row = $('.one-line').html();
            var html = '  <div class="layui-form-item multi-request-body">' + row + '</div>';
            $("#request-body-form").after(html);

            form.render();
        });

        $("#add_response_body_field").click(function (event) {

            let row = $('.one-response-body-line').html();
            var html = '  <div class="layui-form-item">' + row + '</div>';
            $("#response-body-div").after(html);

            form.render();
        });

        $("#add_pathvar_field_btn").click(function (event) {

            let row = $('#first-pathvar-field').html();
            var html = '  <div class="layui-form-item">' + row + '</div>';
            $("#request-pathvar-div").after(html);

            form.render();
        });

        form.on('submit(*)', function (data) {
            var index = layer.load(1);
            var map = getFormData(data.field);

            console.info(map)

            var httpTaskId = null;
            $.ajax({
                type: 'POST',
                dataType: 'JSON',
                contentType: 'application/json;charset=utf-8',
                url: '/restdoc/document/httpTask/submit',
                data: JSON.stringify(map),
                async: false,
                success: function (data) {
                    if (data['code'] === "200") {
                        if (data['data'] != null) {
                            httpTaskId = data['data'];
                        } else {
                            layer.msg("任务提交失败")
                        }
                    } else {
                        layer.msg(data['message'])
                    }

                },
                error: function () {
                    layer.msg("网络异常")
                }
            });

            if (httpTaskId != null) {
                layer.open({
                    type: 2,
                    title: '运行结果',
                    area: ['800px', '700px'],
                    content: "/restdoc/document/view/httpTask/" + httpTaskId,
                    btn: ['保存运行结果', '取消'],
                    isOutAnim: false,
                    skin: 'layui-layer-lan',
                    yes: function (index, layero) {
                        var taskData = window["layui-layer-iframe" + index].getTaskData();
                        if (taskData == null) {
                            layer.msg("保存运行结果失败，请刷新页面重试")
                        } else {
                            layer.close(index);
                        }
                    }
                });
            }

            layer.close(index);

            return false;
        });

    });

    function deleteResponseBodyBtn(obj) {
        var parent = obj.parentNode.parentNode.parentNode
        var children = obj.parentNode.parentNode
        if (children.id === "first-response-field") {
            msg.msg("Not")
        } else {
            parent.removeChild(children)
        }
    }

    function deleteRequestBodyBtn(obj) {

        console.info(obj.id)

        var parent = obj.parentNode.parentNode.parentNode

        var children = obj.parentNode.parentNode

        if (children.id === "first-request-body-field") {
            msg.msg("Not")
        } else {
            parent.removeChild(children)
        }
    }

    function deleteHeaderFieldLine(obj) {
        console.info(obj.id)
        var parent = obj.parentNode.parentNode.parentNode

        var children = obj.parentNode.parentNode


        if (children.id === "first-header-field") {
            msg.msg("Not")
        } else {
            parent.removeChild(children)
        }
    }

    function deleteUriVarFieldLine(obj) {
        console.info(obj.id)
        var parent = obj.parentNode.parentNode.parentNode

        var children = obj.parentNode.parentNode

        if (children.id === "first-pathvar-field") {
            msg.msg("Not")
        } else {
            parent.removeChild(children)
        }
    }


    function getFormData(value) {

        var header = getHeaderKeyValueJsonArray()
        var requestBody = getRequestBodyKeyValueJsonArray()
        var responseBody = getResponseBodyKeyValueJsonArray()

        var map = new Map()

        var url = value["url"]

        if (!new RegExp("^((http)(s?))(.*)$")) {
            url = "http://" + url;
        }
        map['url'] = url
        map['method'] = value["method"]
        map['executeStrategy'] = value["executeStrategy"]
        map['headers'] = header
        map['requestBody'] = requestBody
        map['responseBody'] = responseBody

        return map;
    }


    function getHeaderKeyValueJsonArray() {
        var headerKeyNodes = $('input[name=headerKey]')
        var headerValueNodes = $('input[name=headerValue]')
        var headerDescriptionNodes = $('input[name=headerDescription]')
        var headerConstraintNodes = $('input[name=headerConstraint]')

        var array = [];

        for (let i = 0; i < headerKeyNodes.length; i++) {
            var map = new Map();
            map["headerKey"] = headerKeyNodes[i].value;
            map["headerValue"] = headerValueNodes[i].value;
            map["headerDescription"] = headerDescriptionNodes[i].value;
            map["headerConstraint"] = (headerConstraintNodes[i].value === 'on')

            array[i] = map
        }
        return array
    }

    function getRequestBodyKeyValueJsonArray() {
        var requestFieldPathNodes = $('input[name=requestFieldPath]')
        var requestFieldValueNodes = $('input[name=requestFieldValue]')
        var requestFieldTypeNodes = $('select[name=requestFieldType]')
        var requestFieldDescriptionNodes = $('input[name=requestFieldDescription]')
        var requestFieldConstraintNodes = $('input[name=requestFieldConstraint]')


        var array = [];

        console.info(requestFieldTypeNodes.length);

        for (let i = 0; i < requestFieldPathNodes.length; i++) {
            var map = new Map();
            map["requestFieldPath"] = requestFieldPathNodes[i].value
            map["requestFieldValue"] = requestFieldValueNodes[i].value

            map["requestFieldType"] = requestFieldTypeNodes[i].value;
            map["requestFieldDescription"] = requestFieldDescriptionNodes[i].value;
            map["requestFieldConstraint"] = (requestFieldConstraintNodes[i].value === 'on');

            array[i] = map
        }
        return array
    }

    function getResponseBodyKeyValueJsonArray() {
        var responseFieldPathNodes = $('input[name=responseFieldPath]')
        var responseFieldTypeNodes = $('select[name=responseFieldType]')
        var responseFieldDescriptionNodes = $('input[name=responseFieldDescription]')
        var responseFieldConstraintNodes = $('input[name=responseFieldConstraint]')


        var array = new Array()

        for (let i = 0; i < responseFieldPathNodes.length; i++) {
            var map = new Map()
            map["responseFieldPath"] = responseFieldPathNodes[i].value
            map["responseFieldValue"] = responseFieldDescriptionNodes[i].value

            map["responseFieldType"] = responseFieldTypeNodes[i].value;
            map["responseFieldDescription"] = responseFieldDescriptionNodes[i].value
            map["responseFieldConstraint"] = (responseFieldConstraintNodes[i].value === 'on')

            array[i] = map
        }
        return array
    }

</script>
</body>
</html>