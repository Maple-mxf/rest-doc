<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <!--    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">-->
    <link rel="stylesheet" th:href="@{/layui/css/layui.css}"/>
    <link rel="stylesheet" th:href="@{/admin/css/pearForm.css}"/>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/admin/css/fangge-style.css}"/>
    <link rel="stylesheet" th:href="@{/admin/css/doc-common.css}"/>
    <style>
        #tableContents {
            border-top: 3px solid #009688;
            margin-top: 40px;
        }

        #test1 {
            margin-top: 20px;
        }
    </style>
</head>
<body>
<div th:include="nav::nav"></div>

<input type="hidden" id="projectId" th:value="${projectId}">

<div class="layui-fluid layui-bg-gray">

    <div class="layui-col-md2" id="tableContents">
        <div style="margin-top: 10px">

            <a th:href="@{'/'+${projectId}+'/document/view/api/add'}" class="layui-btn layui-btn-primary"
               target="_blank">创建REST doc</a>
            <a th:href="@{'/'+${projectId}+'/document/view/wiki/add'}" class="layui-btn layui-btn-primary"
               target="_blank">创建WIKI</a>
        </div>

        <fieldset class="layui-elem-field site-demo-button" style="margin-top: 10px;">
            <legend>目录</legend>
            <div>
                <button class="layui-btn" id="createTableContentBtn">创建目录</button>
            </div>
            <div id="test1" style="font-size: 14px"></div>
        </fieldset>
    </div>
    <div class="layui-col-md9" id="docContent">
        <iframe src="" id="docContentFrame" frameborder="0" style="width: 100%;height: 900px"></iframe>
    </div>
</div>
<script th:src="@{/layui/layui.js}"></script>
<script th:src="@{/admin/js/jquery.js}"></script>
<script th:src="@{/admin/js/util.js}"></script>

<script>

    $("#projectNav").addClass("layui-this")

    layui.use([
        'util',
        'layer',
        'element',
        'jquery',
        'tree'], function () {
        var tree = layui.tree;
        var $ = layui.jquery;
        var layer = layui.layer;

        var treeData = null;
        var projectId = $("#projectId").val();

        $.ajax({
            type: 'GET',
            url: '/restdoc/' + projectId + '/resource/tree',
            async: false,
            success: function (data) {
                if (data['code'] === "200") {
                    treeData = data['data'];
                } else {
                    layer.msg(data['message']);
                }
            },
            error: function () {
                layer.msg("网络异常")
            }
        });

        var inst1 = tree.render({
            elem: '#test1'  //绑定元素
            , showLine: false
            , edit: false
            , accordion: false
            // ,onlyIconControl:true
            , data: treeData

            , click: function (obj) {

                console.info(obj.data)

                if (obj.data.type === "WIKI") {
                    /*$.ajax({
                        type: 'GET',
                        url: '/restdoc/document/' + obj.data.id + '/view/wiki',
                        async: false,
                        success: function (res) {
                            $("#docContent").html(res);
                        },
                        error: function () {
                            layer.msg("网络异常");
                        }
                    });*/

                    $("#docContentFrame").attr("src", '/restdoc/document/' + obj.data.id + '/view/wiki');
                } else if (obj.data.type === "API") {
                    /* $.ajax({
                         type: 'GET',
                         url: '/restdoc/document/' + obj.data.id + '/view/api',
                         async: false,
                         success: function (res) {
                             $("#docContent").html(res);
                         },
                         error: function () {
                             layer.msg("网络异常");
                         }
                     });*/

                    $("#docContentFrame").attr("src", '/restdoc/document/' + obj.data.id + '/view/api');
                }

            }
        });

        $('#createTableContentBtn').click(function (event) {
            var projectId = $('#projectId').val();
            layer.open({
                type: 2,
                title: "创建目录/资源",
                content: ['/restdoc/' + projectId + '/resource/view/add', 'no'],
                area: ['800px', '500px'],
                btn: ['保存', '取消'],
                yes: function (index, layerDoc) {
                    var res = window["layui-layer-iframe" + index].getResourceData();
                    let name = res['name'], tag = res['tag'], pid = res['pid'];
                    console.info(res)

                    if (name == '' || tag == '' || pid == '') {
                        layer.msg("请填写信息");
                    } else {
                        $.ajax({
                            type: 'POST',
                            url: '/restdoc/' + projectId + '/resource',
                            data: JSON.stringify(res),
                            contentType: 'application/json;charset=utf-8',
                            async: false,
                            success: function (data) {
                                if (data['code'] === "200") {
                                    layer.close(index);
                                } else {
                                    layer.msg(data['message']);
                                }
                            },
                            error: function () {
                                layer.msg("网络异常");
                            }
                        });
                    }
                }
            });
        });
    });
</script>
</body>
</html>