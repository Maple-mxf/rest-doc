<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>API Explorer</title>
    <link rel="stylesheet" th:href="@{/layui/css/layui.css}"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/layui/css/layui.css}"/>
    <link rel="stylesheet" th:href="@{/admin/css/pearForm.css}"/>
    <link rel="stylesheet" th:href="@{/admin/css/easyeditor.css}"/>
    <link rel="stylesheet" th:href="@{/admin/css/fangge-style.css}"/>
    <link rel="stylesheet" th:href="@{/admin/css/pear-tree/dtree.css}"/>
    <link rel="stylesheet" th:href="@{/admin/css/doc-common.css}"/>
    <link rel="stylesheet" th:href="@{/admin/css/code.css}"/>
    <link rel="stylesheet" th:href="@{/admin/css/nav.css}"/>

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            font-size: 15px;
        }

        pre {
            background-color: #283142;
            color: white;
            font-size: 16px;
            font-family: Roboto, serif;
        }

        .code-block {
            background-color: #283142;
            color: white;
            font-size: 16px;
            font-family: Roboto, serif;
        }

        /*.common-code-pre {
            background: #f4f4f4;
            border: 1px solid #ddd;
            border-left: 3px solid #f36d33;
            color: #666;
            page-break-inside: avoid;
            font-family: Roboto, serif;
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 1.6em;
            max-width: 100%;
            overflow: auto;
            padding: 1em 1.5em;
            display: block;
            word-wrap: break-word;
        }*/

        .layui-table td, .layui-table th {
            color: #0C0C0C;
            font-size: 15px;
        }

        .layui-table th {
            text-align: center;
        }

        .layui-table th {
            font-weight: bold;
        }

        .headerTitle {
            font-family: Roboto, serif;
            margin-top: 30px;
            font-weight: bold;
        }

        #urlSpan:hover {
            cursor: pointer;
        }


        /*.layui-tab-title li {
            font-size: 18px;
            font-family: Roboto, serif;
            padding: 0 5%;
        }*/

        .layui-code {
            font-size: 14px;
            font-family: Roboto, serif;
        }

        #editDocDescriptionBtn:hover {
            cursor: pointer;
        }

        tr:hover {
            cursor: pointer;
        }

        body {
            background-color: white;
        }

    </style>

</head>
<body>
<input id="projectId" type="hidden" th:value="${projectId}">

<script type="text/html" id="uriDescriptionTpl">
    <span>{{d.description}}</span>
    <span lay-event="description" id="description" title="编写备注" style="position: absolute; bottom: -8px; right: 10px"><i
            class="layui-icon layui-icon-edit" style="font-size: 25px; color: #009688;"></i></span>
</script>

<div class="layui-fluid">
    <div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">
        <ul class="layui-tab-title">
            <li class="layui-this">文档</li>
            <li>调试</li>
            <li>Agent列表</li>
        </ul>
        <div class="layui-tab-content">
            <div class="layui-tab-item layui-show layui-container">
                <div class="layui-row">
                    <div class="layui-col-md12">
                        <span style="margin-left: 2%"><h2 th:text="${document.name}"></h2></span>
                        <div class="layui-row code-block" style="margin-top: 1%; height: 60px;line-height: 60px; ">
                            <span style="margin-left: 2%">HTTP1.1 GET <span th:text="${document.url}"></span></span>
                            <span id="urlSpan" style="position: absolute;right: 10px;margin-top: -1%"><i
                                    class="layui-icon layui-icon-file-b" style="font-size: 25px; color: whitesmoke;"
                                    title="复制URL" id="copyURL"></i></span>
                        </div>
                        <div class="layui-row">

                            <h3 class="headerTitle">备注 <span><i class="layui-icon layui-icon-edit"
                                                                id="editDocDescriptionBtn"
                                                                style="font-size: 20px; color: #FF5722;font-weight: normal"></i></span>
                            </h3>
                            <blockquote class="layui-elem-quote">
                                <div class="layui-text	" th:utext="${document.description}"
                                     id="descriptionArea"></div>
                            </blockquote>
                        </div>
                        <div class="layui-row"
                             th:if="${document.uriVarDescriptors!=null and !document.uriVarDescriptors.isEmpty()}">
                            <h3 class="headerTitle">URI路径参数列表 &nbsp;&nbsp;&nbsp;
                                <i class="layui-icon layui-icon-rate"
                                   style="font-size: 18px; color: #FF5722;font-weight: normal">
                                    <span style="font-size: 14px;color: #FF5722">Tip：双击行可以编辑文档 </span></i>
                            </h3>
                            <p>
                            </p>
                            <table class="layui-table" id="uriFieldListTable" lay-size="lg">
                                <colgroup>
                                    <col width="220">
                                    <col width="220">
                                    <col width="400">
                                    <col>
                                </colgroup>
                                <thead>
                                <tr>
                                    <th>参数</th>
                                    <th>示例值</th>
                                    <th>说明</th>
                                </tr>
                                </thead>
                                <tbody id="uriFieldListTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="layui-row"
                             th:if="${document.requestHeaderDescriptor!=null and !document.requestHeaderDescriptor.isEmpty()}">
                            <h3 class="headerTitle">请求头参数列表
                                &nbsp;&nbsp;&nbsp;
                                <i class="layui-icon layui-icon-rate"
                                   style="font-size: 18px; color: #FF5722;font-weight: normal">
                                    <span style="font-size: 14px;color: #FF5722">Tip：双击行可以编辑文档 </span></i></h3>
                            <p>
                            <table class="layui-table" id="requestHeaderListTable" lay-size="lg">
                                <colgroup>
                                    <col width="200">
                                    <col width="250">
                                    <col width="180">
                                    <col>
                                </colgroup>
                                <thead>
                                <tr>
                                    <th>参数</th>
                                    <th>示例值</th>
                                    <th>是否可选</th>
                                    <th>说明</th>
                                </tr>
                                </thead>
                                <tbody id="requestHeaderListTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="layui-row"
                             th:if="${document.requestBodyDescriptor!=null and !document.requestBodyDescriptor.isEmpty()}">
                            <h3 class="headerTitle">请求参数列表 <i class="layui-icon layui-icon-rate"
                                                              style="font-size: 18px; color: #FF5722;font-weight: normal">
                                <span style="font-size: 14px;color: #FF5722">Tip：双击行可以编辑文档 </span></i></h3>
                            <p>

                            <table class="layui-table" id="requestBodyFieldListTable" lay-size="lg">
                                <colgroup>
                                    <col width="200">
                                    <col width="120">
                                    <col width="200">
                                    <col width="200">
                                    <col>
                                </colgroup>
                                <thead>
                                <tr>
                                    <th>参数</th>
                                    <th>类型</th>
                                    <th>示例值</th>
                                    <th>是否可选</th>
                                    <th>说明</th>
                                </tr>
                                </thead>
                                <tbody id="requestBodyFieldListTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="layui-row"
                             th:if="${document.responseBodyDescriptors!=null and !document.responseBodyDescriptors.isEmpty()}">
                            <h3 class="headerTitle">响应参数列表 <i class="layui-icon layui-icon-rate"
                                                              style="font-size: 18px; color: #FF5722;font-weight: normal">
                                <span style="font-size: 14px;color: #FF5722">Tip：双击行可以编辑文档 </span></i></h3>
                            <p>
                            <table class="layui-table" id="responseBodyFieldListTable" lay-size="lg">
                                <colgroup>
                                    <col width="150">
                                    <col width="120">
                                    <col width="150">
                                    <col width="200">
                                    <col>
                                </colgroup>
                                <thead>
                                <tr>
                                    <th>参数</th>
                                    <th>类型</th>
                                    <th>示例值</th>
                                    <th>说明</th>

                                </tr>
                                </thead>
                                <tbody id="responseBodyFieldListTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="layui-row">
                            <h3 class="headerTitle">代码示例</h3>
                            <div class="layui-tab layui-tab-card">
                                <ul class="layui-tab-title">
                                    <li class="layui-this">CURL</li>
                                    <li>Java</li>
                                    <li>Python</li>
                                </ul>
                                <div class="layui-tab-content" style="height: 500px;">
                                    <div class="layui-tab-item layui-show">
                                        <pre style="font-size: 16px" class="layui-code "
                                             th:text="${document.curlCodeSample}"></pre>
                                    </div>
                                    <div class="layui-tab-item">
                                        <pre style="font-size: 16px" class="layui-code "
                                             th:text="${document.javaCodeSample}"></pre>
                                    </div>
                                    <div class="layui-tab-item">
                                        <pre style="font-size: 16px" class="layui-code "
                                             th:text="${document.pythonCodeSample}"></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-tab-item">
                <iframe id="testApiFrame" th:src="@{'/'+${projectId}+'/document/view/'+${document.id}+'/test'}"
                        style="width: 100%;height: 900px" frameborder=”no” border=”0″ marginwidth=”0″
                        marginheight=”0″></iframe>
            </div>

            <div class="layui-tab-item">

            </div>
        </div>
    </div>
</div>

<script th:src="@{/layui/layui.js}"></script>
<script th:src="@{/admin/js/jquery.js}"></script>
<script th:src="@{/admin/js/util.js}"></script>
<script th:inline="javascript">

    var documentId = [[${document.id}]];
    var doc = [[${document}]];
    var url = [[${document.url}]];

    var lay = null;

    layui.use(['table', 'util', 'layer', 'element', 'jquery', 'layedit', 'form'],
        function () {
            var $ = layui.jquery;
            var layer = layui.layer;
            var element = layui.element;
            util = layui.util;
            lay = layer;

            element.on('tab(docDemoTabBrief)', function (data) {
                if (0 === data.index) {
                    var projectId = $("#projectId").val();
                    $("#testApiFrame").attr("src", "/restdoc/" + projectId + '/document/view/' + documentId + "/test")
                }
            });

            renderURITable(doc['uriVarDescriptors']);
            renderRequestHeaderTable(doc['requestHeaderDescriptor']);
            renderRequestBodyTable(doc['requestBodyDescriptor']);
            renderResponseBodyTable(doc['responseBodyDescriptors']);


            $("#editDocDescriptionBtn").click(function (event) {
                layer.open({
                    type: 2,
                    title: "编辑文档备注",
                    area: ['800px', '600px'],
                    content: ['/restdoc/document/' + documentId + '/snippet/view?type=description&field=1', 'no'],
                    btn: ["保存", "取消"],
                    yes: function (index, dom) {
                        var res = window["layui-layer-iframe" + index].getValue();
                        var doc = updateDocumentTable("description", res);
                        if (doc != null) {
                            renderDescription(doc['description'])
                        }
                        layer.close(index)
                    }
                });
            });
        });

    $("#copyURL").click(function () {
        const input = document.createElement('input');
        document.body.appendChild(input);
        input.setAttribute('value', url);
        input.select();
        if (document.execCommand('copy')) {
            document.execCommand('copy');
            layer.msg("复制成功")
        }
        document.body.removeChild(input);
    });


    function renderURITable(uriFields) {
        if (uriFields !== null && uriFields.length > 0) {
            var allLine = "";

            for (let i = 0; i < uriFields.length; i++) {
                var param = "'" + uriFields[i]['field'] + "'";
                var fun = "openEditVarPage(" + param + ")";
                var line = '<td>' + uriFields[i]['field'] + '</td>' + '<td>' + uriFields[i]['value'] + '</td>' + '<td>' + uriFields[i]['description'] + '</td>';
                var start = "<tr ondblclick=" + fun + ">", end = "</tr>";
                allLine = allLine + start + line + end;
            }
            $("#uriFieldListTableBody").html(allLine)
        }
    }

    function renderRequestHeaderTable(headerFields) {
        if (headerFields !== null && headerFields.length > 0) {
            var allLine = "";
            for (let i = 0; i < headerFields.length; i++) {

                var param = "'" + headerFields[i]['field'] + "'";
                var fun = "openEditRequestHeaderPage(" + param + ")";

                var line = '<td>' + headerFields[i]['field'] + '</td>' + '<td>' + headerFields[i]['value'] + '</td>' + '<td>' + headerFields[i]['optional'] + '</td>' + '<td>' + headerFields[i]['description'] + '</td>';

                var start = "<tr ondblclick=" + fun + ">", end = "</tr>";
                allLine = allLine + start + line + end;
            }
            $("#requestHeaderListTableBody").html(allLine);
        }
    }


    function renderRequestBodyTable(requestBodyFields) {
        if (requestBodyFields !== null && requestBodyFields.length > 0) {

            var allLine = "";
            for (let i = 0; i < requestBodyFields.length; i++) {

                var param = "'" + requestBodyFields[i]['path'] + "'";
                var fun = "openEditRequestBodyPage(" + param + ")";
                var start = "<tr ondblclick=" + fun + ">", end = "</tr>";

                var line = '<td>' + requestBodyFields[i]['path'] + '</td>' + '<td>' + requestBodyFields[i]['type'] + '</td>' + '<td>' + requestBodyFields[i]['value'] + '</td>' + '<td>' + requestBodyFields[i]['optional'] + '</td>' + '<td>' + requestBodyFields[i]['description'] + '</td>';
                allLine = allLine + start + line + end;
            }
            $("#requestBodyFieldListTableBody").html(allLine)
        }
    }

    function renderResponseBodyTable(responseBodyFields) {
        if (responseBodyFields !== null && responseBodyFields.length > 0) {
            var allLine = "";
            for (let i = 0; i < responseBodyFields.length; i++) {

                var param = "'" + responseBodyFields[i]['path'] + "'";
                var fun = "openEditResponseBodyPage(" + param + ")";
                var start = "<tr ondblclick=" + fun + ">", end = "</tr>";

                var line = '<td>' + responseBodyFields[i]['path'] + '</td>' + '<td>' + responseBodyFields[i]['type'] + '</td>' + '<td>' + responseBodyFields[i]['value'] + '</td>' + '<td>' + responseBodyFields[i]['description'] + '</td>';
                allLine = allLine + start + line + end;
            }
            $("#responseBodyFieldListTableBody").html(allLine)
        }
    }

    function openEditVarPage(field) {
        lay.open({
            type: 2,
            title: "编辑URI路径参数",
            area: ['800px', '600px'],
            content: ['/restdoc/document/' + documentId + '/snippet/view?type=uri&field=' + field, 'no'],
            btn: ["保存", "取消"],
            yes: function (index, dom) {
                var res = window["layui-layer-iframe" + index].getValue();
                var doc = updateDocumentTable("uri", res);

                if (doc != null) {
                    renderURITable(doc['uriVarDescriptors'])
                }
                lay.close(index)
            }
        });
    }

    function openEditRequestHeaderPage(field) {
        lay.open({
            type: 2,
            title: "编辑请求头参数",
            area: ['800px', '600px'],
            content: ['/restdoc/document/' + documentId + '/snippet/view?type=requestHeader&field=' + field, 'no'],
            btn: ["保存", "取消"],
            yes: function (index, dom) {
                var res = window["layui-layer-iframe" + index].getValue();
                var doc = updateDocumentTable("requestHeader", res);
                if (doc != null) {
                    renderRequestHeaderTable(doc['requestHeaderDescriptor'])
                }
                lay.close(index)
            }
        });
    }

    function openEditRequestBodyPage(field) {
        lay.open({
            type: 2,
            title: "编辑请求体参数",
            area: ['800px', '600px'],
            content: ['/restdoc/document/' + documentId + '/snippet/view?type=requestBody&field=' + field, 'no'],
            btn: ["保存", "取消"],
            yes: function (index, dom) {
                var res = window["layui-layer-iframe" + index].getValue();
                var doc = updateDocumentTable("requestBody", res);
                if (doc != null) {
                    renderRequestBodyTable(doc['requestBodyDescriptor'])
                }
                lay.close(index)
            }
        });
    }

    function openEditResponseBodyPage(field) {
        lay.open({
            type: 2,
            title: "编辑响应体参数",
            area: ['800px', '600px'],
            content: ['/restdoc/document/' + documentId + '/snippet/view?type=responseBody&field=' + field, 'no'],
            btn: ["保存", "取消"],
            yes: function (index, dom) {
                var res = window["layui-layer-iframe" + index].getValue();
                var doc = updateDocumentTable("responseBody", res);
                if (doc != null) {
                    renderResponseBodyTable(doc['responseBodyDescriptors'])
                }
                lay.close(index)
            }
        });
    }

    function renderDescription(description) {
        $("#descriptionArea").html(description)
    }

    function updateDocumentTable(type, data) {
        var returnValue = null;
        $.ajax({
            method: 'PATCH',
            url: '/restdoc/document/' + documentId + '/snippet/' + type,
            contentType: 'application/json;charset=utf-8',
            dataType: 'json',
            data: JSON.stringify(data),
            async: false,
            success: function (data) {
                if ('200' === data['code']) {
                    returnValue = data['data'];
                    layer.msg("文档修改成功");
                } else {
                    layer.msg(data['message']);
                }
            }
        });
        return returnValue;
    }

</script>
</body>
</html>