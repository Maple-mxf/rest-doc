<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>文档中心</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <!--    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">-->
    <link rel="stylesheet" th:href="@{/layui/css/layui.css}"/>
    <link rel="stylesheet" th:href="@{/admin/css/pearForm.css}"/>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/admin/css/fangge-style.css}"/>
    <link rel="stylesheet" th:href="@{/admin/css/doc-common.css}"/>
    <link rel="stylesheet" th:href="@{/admin/css/nav.css}"/>
</head>
<body>
<div class="layui-row" style="width: 100%">
    <ul class="layui-nav layui-bg-green" id="navigation" lay-filter="test">
        <li class="layui-nav-item">
            <a href="/restdoc/project/view"> <i class="layui-icon layui-icon-return"
                                                style="font-size: 17px;  color: white;"></i>&nbsp;</a>
        </li>
        <li class="layui-nav-item layui-this"><a id="home" th:href="@{'/'+${projectId}+'/document/nav/view'}">文档</a>
        </li>
        <li class="layui-nav-item"><a id="projectDetail" href="javascript:;">项目详情</a></li>
        <li class="layui-nav-item"><a id="clientServiceList" href="javascript:;">服务实例<span class="layui-badge"
                                                                                           th:text="${instanceNumber}"></span></a>
        </li>
        <li class="layui-nav-item"><a id="tableContentManage" href="javascript:;">目录管理</a></li>
        <!--        <li class="layui-nav-item"><a id="createAPI" target="_blank" th:href="@{'/'+${projectId}+'/document/view/api/add'}">创建API</a>-->
        <li class="layui-nav-item"><a id="createAPI" href="javascript:;">创建API</a>
        <li class="layui-nav-item"><a id="createWIKI" href="javascript:;">创建WIKI</a>
        </li>
    </ul>
</div>

<input type="hidden" id="projectId" th:value="${projectId}">

<div id="tableContents" style="display: none">
    <div id="navTableOfContent" style="font-size: 14px"></div>
</div>

<div class="layui-fluid">
    <iframe src="" id="docContentFrame" frameborder="0" style="width: 100%;height: 1000px;"></iframe>
</div>
<script th:src="@{/layui/layui.js}"></script>
<script th:src="@{/admin/js/jquery.js}"></script>
<script th:src="@{/admin/js/util.js}"></script>

<script>

    var isOpenTableContent = false;

    layui.use([
        'util',
        'layer',
        'element',
        'jquery',
        'tree'], function () {
        var tree = layui.tree;
        var $ = layui.jquery;
        var layer = layui.layer;
        var element = layui.element;
        var treeData = null;
        var projectId = $("#projectId").val();
        var util = layui.util;

        element.on('nav(test)', function (elem) {
            if ('clientServiceList' === elem[0].id) {
                /*layer.open({
                    type: 2,
                    content: '/restdoc/microservice/view/list?ap=REST_WEB&projectId=' + projectId,
                    title: '服务实例列表',
                    area: ['1200px', '600px'],
                    btn: ['确定'],
                    yes: function (index, doc) {
                        layer.close(index)
                    },
                    end: function (index) {
                        resetNavData();
                        tree.reload("navTableOfContent", {data: treeData});
                        layer.close(index);
                    }
                });*/
                layer.closeAll();
                $("#docContentFrame").attr("src", '/restdoc/microservice/view/list?ap=REST_WEB&projectId=' + projectId);
            } else if ('projectDetail' === elem[0].id) {
               /* layer.open({
                    title: '项目详情',
                    area: ['500px', '400px'],
                    // scrollbar: false,
                    type: 2,
                    content: '/restdoc/project/' + projectId + '/view'
                });*/
                layer.closeAll();
                $("#docContentFrame").attr("src", '/restdoc/project/' + projectId + '/view');

            } else if ('tableContentManage' === elem[0].id) {
                /*layer.open({
                    title: '目录管理',
                    area: ['800px', '500px'],
                    scrollbar: false,
                    type: 2,
                    content: '/restdoc/' + projectId + '/resource/view/table',
                    end: function () {
                        resetNavData();
                        tree.reload("navTableOfContent", {data: treeData});
                    }
                });*/
                layer.closeAll();
                $("#docContentFrame").attr("src", '/restdoc/' + projectId + '/resource/view/table');
            } else if ('createAPI' === elem[0].id) {
                // http://localhost:8432/restdoc/746946688983240704/document/view/api/add
                layer.closeAll();
                $("#docContentFrame").attr("src", '/restdoc/' + projectId + '/document/view/api/add');
            } else if ('createWIKI' === elem[0].id) {
                // http://localhost:8432/restdoc/746946688983240704/document/view/wiki/add
                layer.closeAll();
                $("#docContentFrame").attr("src", '/restdoc/' + projectId + '/document/view/wiki/add');
            }
        });

        function resetNavData() {
            $.ajax({
                type: 'GET',
                url: '/restdoc/' + projectId + '/resource/tree',
                async: false,
                success: function (data) {
                    if (data['code'] === "200") {
                        treeData = data['data'];
                    } else {
                        layer.msg(data['message']);
                    }
                },
                error: function () {
                    layer.msg("网络异常")
                }
            });
        }

        resetNavData();
        var docId = getFirstDocument(treeData);
        if (null != docId) {
            $("#docContentFrame").attr("src", '/restdoc/' + projectId + '/document/' + docId + '/view');
        }

        $.ajax({
            type: 'GET',
            url: '/restdoc/' + projectId + '/resource/tree',
            async: false,
            success: function (data) {
                if (data['code'] === "200") {
                    treeData = data['data'];
                    var docId = getFirstDocument(treeData);
                    if (null != docId) {
                        $("#docContentFrame").attr("src", '/restdoc/' + projectId + '/document/' + docId + '/view');
                    }
                } else {
                    layer.msg(data['message']);
                }
            },
            error: function () {
                layer.msg("网络异常")
            }
        });

        //执行
        util.fixbar({
            bar1: true,
            var2: false,
            click: function (type) {
                if (!isOpenTableContent) {
                    openTableContent();
                }
            }
        });
        openTableContent();

        function openTableContent() {
            layer.open({
                type: 1,
                title: '目录',
                content: $('#tableContents'),
                shadeClose: true,
                shade: 0,
                offset: 'r',
                // closeBtn: 0,
                area: ['350px', '600px'],
                zIndex: layer.zIndex,
                success: function (layero) {
                    layer.setTop(layero);
                },
                end: function () {
                    isOpenTableContent = false;
                }
            });
            isOpenTableContent = true;
        }

        tree.render({
            elem: '#navTableOfContent'
            , id: "navTableOfContent"
            , data: treeData
            , edit: ['update', 'del']
            , click: function (obj) {
                if (obj.data.type === "WIKI" || obj.data.type === "API") {
                    $("#docContentFrame").attr("src", '/restdoc/' + projectId + '/document/' + obj.data.id + '/view');
                }
            },
            operate: function (obj) {
                var type = obj.type;
                var data = obj.data;

                if (type == 'del') {
                    if (data.type == 'WIKI' || data.type == 'API') {
                        deleteTreeNode('/restdoc/document/' + data.id);
                    } else {
                        deleteTreeNode('/restdoc/' + projectId + '/resource/' + data.id);
                    }
                } else if (type == 'update') {
                    var body = {"name": data.title};
                    if (data.type == 'WIKI' || data.type == 'API') {
                        editTreeNode('/restdoc/document/' + data.id, body)
                    } else {
                        editTreeNode('/restdoc/resource/' + data.id, body)
                    }
                }
            }
        });

        function editTreeNode(url, body) {
            $.ajax({
                type: 'PATCH',
                url: url,
                contentType: 'application/json;charset=utf-8',
                dataType: "JSON",
                data: JSON.stringify(body),
                async: false,
                success: function (data) {
                    if (data['code'] === "200") {
                        layer.msg("操作成功")
                    } else {
                        layer.msg(data['message']);
                    }
                },
                error: function () {
                    layer.msg("网络异常")
                }
            });
        }

        function deleteTreeNode(url) {
            $.ajax({
                type: "DELETE",
                url: url,
                async: false,
                success: function (data) {
                    if (data['code'] === "200") {
                        layer.msg("操作成功")
                    } else {
                        layer.msg(data['message']);
                    }
                },
                error: function () {
                    layer.msg("网络异常")
                }
            });
        }

        $('#createTableContentBtn').click(function (event) {
            var projectId = $('#projectId').val();
            layer.open({
                type: 2,
                title: "创建目录/资源",
                content: ['/restdoc/' + projectId + '/resource/view/add', 'no'],
                area: ['800px', '500px'],
                btn: ['保存', '取消'],
                yes: function (index, layerDoc) {
                    var res = window["layui-layer-iframe" + index].getResourceData();
                    let name = res['name'], tag = res['tag'], pid = res['pid'];
                    console.info(res)

                    if (name == '' || tag == '' || pid == '') {
                        layer.msg("请填写信息");
                    } else {
                        $.ajax({
                            type: 'POST',
                            url: '/restdoc/' + projectId + '/resource',
                            data: JSON.stringify(res),
                            contentType: 'application/json;charset=utf-8',
                            async: false,
                            success: function (data) {
                                if (data['code'] === "200") {
                                    layer.close(index);
                                } else {
                                    layer.msg(data['message']);
                                }
                            },
                            error: function () {
                                layer.msg("网络异常");
                            }
                        });
                    }
                }
            });
        });
    });

    $('#restweb-project-nav').addClass("layui-this");

    function getFirstDocument(array) {
        if (array == null || array.length === 0) return null;
        var length = array.length;
        var flag = 0;
        for (let i = 0; i < length; i++) {
            var node = array[i];
            if ("API" === node['type'] || "WIKI" === node['type']) {
                if (flag === 0) {
                    return node['id']
                }
            } else {
                var result = findFirstChildren(node);
                if (result != null) return result;
            }
        }
        return null;
    }

    function findFirstChildren(parentNode) {
        if (parentNode != null && parentNode['children'].length === 0) {
            return null;
        } else {
            var children = parentNode['children'];
            var length = children.length;

            for (let i = 0; i < length; i++) {
                if (children[i]['type'] === 'WIKI' || children[i]['type'] === 'API') {
                    return children[i]['id']
                } else {
                    var result = findFirstChildren(children[i]);
                    if (null != result) {
                        return result;
                    }
                }
            }
            return null;
        }
    }
</script>
</body>
</html>